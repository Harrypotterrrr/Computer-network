<meta charset="utf-8" lang="en"><style class="fallback">body{visibility:hidden;}</style>

**瀹よ绋缂浣跨ㄦ规**
    1651574 璐炬17


# 姝ｅ父绋搴拌琛板
## 戒护

- `&`戒护
~~~~~~~~~ bash
./test1-1 &
~~~~~~~~~
璇ュ戒护灏ц绋搴惧板版ц锛浣杈鸿浼剧ず板缁绔锛褰卞ㄦ锋浣锛浠ユ濂芥灏杈洪瀹板朵浠17
~~~~~~~~~ bash
./test1-1 & > output.txt
~~~~~~~~~
- `jobs`戒护ョㄥ版ц浣涓骞舵惧颁涓瀵瑰ID锛ュ戒护棰椤-l 浠ユョPID
- `ctrl+z`戒护锛灏宸茬ㄥ拌琛浣涓惧板版ц
- `ctrl+c`戒护锛灏拌琛浣涓缁姝㈣琛17
- `fg %n` 灏版ц杩绋n璋板版ц锛n琛ㄧずjobnumber锛棰杩jobsョ杩绋缂凤pid锛17
ц `fg %1` (板充浣涓, 澶浠ヤ版浣跨17 %+ 17 %% ╂汨璧风浣涓17, 浠ュ %- ╃浜杩璧风浣涓17) 灏17 1 蜂涓㈠板
- `bg %n` 灏ㄥ版璧风杩绋n锛缁х画ц17
- `kill %n` 沔拌琛杩绋锛n琛ㄧずjobnumber锛棰杩jobsョ杩绋缂凤pid锛17

- `tty`戒护锛峰у跺扮 TTY 璁惧17
- `ps`甯哥ㄦ浠ゅぇ
椤        |    
----------------|------------
涓浠讳椤     |   ョ褰缁绔涓姝ｅㄨ琛杩绋
-A, -e          |   ㄩㄨ绋淇℃
a               |   ョ17
f               |   浠ユ褰㈠ョ跺杩绋崇17
-p              |   峰涓PID杩绋淇℃锛17-l 峰璇缁淇℃
j               |   ョ褰
-t TTY璁惧17    |   ョ瀹璁惧杩绋
--help a        |   ョps甯╃ㄩㄩ椤

- `echo $$`浠ゅ浠ユョ褰у跺bashPID

- pstree -p PID17 ョ褰绋

![](./pic/1-8.png)

## 瀹搴
濡炬沌ず锛灏171疯绋璧锋惧ュ板拌ュ拌琛17

![](./pic/1-1.png)

姝ゅ锛`jobs -l`戒护浠ユヨ浣涓蜂互PID

![](./pic/1-2.png)

ョ惰绋ㄤ杩版浠わ
~~~~~~~~~ bash
    ps -p 瀛杩绋 -o ppid=   17
    ps -p 瀛杩绋 -l
~~~~~~~~~
![](./pic/1-3.png)

ㄥ涓沔у跺扮绔ョㄧㄦ风杩绋锛茶绋锛
![](./pic/1-5.png)

ㄥ涓沔у跺扮绔ョ杩绋剁惰绋锛`ps -p 瀛杩绋 -l`
![](./pic/1-4.png)

浣test1-1,test1-2ㄥ拌琛锛杩`CTRL+D`沐17
![](./pic/1-6.png)

ㄥ涓沅釜у跺版ョ锛拌ヨ绋宸茬17
![](./pic/1-7.png)

娆′娇test1-1,test1-2ㄥ拌琛锛杩`exit`琚`logout`沐17
![](./pic/1-9.png)

ㄥ涓涓у跺版ョ锛瑙瀵拌绋娌℃缁锛舵涓轰T
![](./pic/1-10.png)

!!! Tip
    Linux processSTAT舵锛
    R (TASK_RUNNING)锛ц舵恽17
    S (TASK_INTERRUPTIBLE)锛涓＄舵恽17
    T (TASK_STOPPED or TASK_TRACED)锛舵璺韪舵恽17
    D (TASK_UNINTERRUPTIBLE)锛涓涓＄舵恽17
    Z (TASK_DEAD - EXIT_ZOMBIE)锛棰恽沐虹舵锛杩绋涓哄靛案杩绋17
    X (TASK_DEAD - EXIT_DEAD)锛棰恽沐虹舵锛杩绋冲琚姣恽17

涓ヨ姊慊缁锛寸濡涓锛
!!! WARNING
    1. bash缁绔涓17,Ctrl-D 瀛绗琛ㄧず杈ユ瀹姣17 (EOF), 浼璁 bash 靛惊姝ｅ父娴绋沐17 (ヤ澶璁剧疆蹇界 EOF).
    
    2. exit 17 logout 蜂浣 bash 姝ｅ父沐17. 姝ゆ, 璇17 bash ㄧ拌琛浣涓涓浼棰恽沐17 (浣版璧蜂涓浼沐17), 浣涓哄ゅ胯绋琚17 init (1 疯绋17) ョ撼浣涓哄杩绋17.

    3. 瑰 SSH 绐ｆ17 Linux 妗㈢澧涓17 Terminal 绐ｇ17 X17 棰恽沐17, 浼17 bash 涓涓17 SIGHUP 淇″, bash 跺板涔浼瀹绠＄沔浣涓17 SIGHUP 淇″(ら璇ヤ涓 disown -h %1 ゅ17 SIGHUP 淇″风＄琛). 跺 SIGHUP 淇″风杩绋17, 榛璁ょ姝.
    拌琛杩绋ㄥ浣涓戒琚缁姝17.

![](./pic/1-11.png)


# 瀹よ绋缂浣跨ㄦ规
## 棰澶ヨ
### 杩绋缁17
杩绋缁灏辨涓绯诲镐宠杩绋锛绯荤涓姣涓涓杩绋涔蹇椤讳灞浜涓沅釜杩绋缁锛姣涓杩绋缁涓戒涓沅釜涓沌17 ID(process group id)锛绠绉17 PGID锛PGID 涓汨绛浜杩绋缁寤鸿绋17 Process ID锛琚杩涓杩杩绋涓汨涔浼琚绉颁负杩绋缁瀵17(process group leader)锛涓汨绋缁涓や杩绋缁瀵煎朵杩绋芥跺杩绋17
杩绋缁瀛锛逛究浜绯荤瀵瑰涓稿宠绋ц浜缁涓沌浣锛渚濡锛浠浠ヤ娆℃悃涓涓淇″烽缁涓汨绋缁涓杩绋恽17
### 浼璇
浼璇锛session锛涓沅釜ュ共杩绋缁锛风锛绯荤涓姣涓沅釜杩绋缁涔藉椤讳灞浜涓沅釜浼璇锛涓沅釜浼璇ユ沐涓涓у剁绔锛涔浠ユ病锛锛璇ョ绔涓轰璇涓沔杩绋缁涓杩绋沐辩ㄣ17
涓沅釜浼璇涓**拌绋缁17**浼涓涓锛朵腑杩绋浠ュу剁绔杩琛浜や锛や拌绋缁澶杩绋缁锛芥17**拌绋缁17**
杩绋缁瀵肩被浼硷浼璇涓涔**浼璇瀵**(session leader)姒蹇碉ㄦヨ〃绀哄缓绔璧峰版у剁绔杩ョ杩绋恽ㄦユу剁绔浼璇涓锛session leader 涔琚绉颁负у惰绋(controlling process)锛涓ヨ存у惰绋涔灏辨诲ョ郴缁17 shell 杩绋(login shell)

![](./pic/2-1.png)

剧涓17
PPID 惰绋 id
PID 杩绋17 id
PGID 杩绋缁 id
SID 浼璇17 id
TTY 浼璇у剁绔璁惧
TPGID 拌绋缁17 PGID
COMMAND 杩绋ц戒17

### 淇″
淇″凤signal锛灏辨ユ涓杩绋浜涓浜浠剁棰ワ朵杞浠朵腑17

### SIGHUP淇″
[瀛涔缃绔](https://blog.csdn.net/z_ryan/article/details/80952498)

SIGHUP 淇″峰ㄧㄦ风绔杩17(姝ｅ父姝ｅ父)缁跺17, 甯告ㄧ绔у惰绋缁, ュ涓session涓浣涓, 杩跺浠涓у剁绔涓宠17. 绯荤瀵SIGHUP淇″风榛璁ゅ缁姝㈡跺拌ヤ俊风杩绋浠ヨョ搴涓娌℃璇ヤ俊凤褰跺拌ヤ俊锋讹杩绋灏变棰恽沐恒17 
沣 
SIGHUP浼ㄤ互涓3绉典琚缁稿杩绋17:
- 缁绔抽讹璇ヤ俊疯棰session棣杩绋浠ュ浣涓job浜ょ杩绋锛崇 & 绗锋浜ょ杩绋17  
- session棣杩绋棰恽沐烘讹璇ヤ俊疯拌session涓拌绋缁涓姣涓沅釜杩绋17 
- 惰绋棰恽沐哄艰磋绋缁涓哄ゅ胯绋缁锛涓璇ヨ绋缁涓杩绋澶浜姝㈢舵锛跺SIGSTOPSIGTSTP淇″凤锛璇ヤ俊蜂琚拌ヨ绋缁涓姣涓涓杩绋17 

  渚濡锛ㄦ浠诲Linux讹绯荤浼缁诲ㄦ蜂涪沅釜缁绔17(Session)ㄨ涓缁绔杩琛绋搴锛拌绋缁拌绋缁锛涓汨藉浜杩涓 Session褰ㄦ烽沐Linux诲讹拌绋缁版瀵圭绔杈虹杩绋灏浼跺SIGHUP淇″枫杩涓淇″风榛璁ゆ浣涓虹姝㈣绋锛姝ゅ拌17 绋缁版缁绔杈虹杩绋灏变涓姝恽17

姝ゅ锛瀵逛涓缁绔辩诲崇郴瀹よ绋锛杩涓淇″风ㄤュ拌诲缃浠躲17 姣濡xinetd瓒绾ф＄搴17 
沣沐xinetd绋搴ㄦユ跺SIGHUP淇″蜂璋hard_reconfig芥帮瀹灏寰璇诲17/etc/xinetd.d/褰涓姣涓瀛缃浠讹骞舵娴跺17

### SIGCHLD淇″
ㄤ涓杩绋缁姝㈡姝㈡讹灏SIGCHLD淇″峰棰缁剁惰绋锛绯荤榛璁ゅ蹇界ユや俊凤濡惰绋甯琚ュ跺绯荤杩绉舵锛搴姝や俊17
姝や俊蜂靛案杩绋澶17

### SIGTERM淇″
绋搴缁(terminate)淇″, 涓SIGKILL涓璇ヤ俊峰浠ヨ诲澶恽棰甯哥ㄦヨ姹绋搴宸辨ｅ父沐猴shell戒护kill缂虹浜х杩涓淇″枫濡杩绋缁姝涓浜锛浠浼灏璇SIGKILL

### SIGINT淇″
绋搴缁姝(interrupt)淇″, ㄧㄦ烽INTR瀛绗(甯告Ctrl-C)跺猴ㄤュ拌绋缁缁姝㈣绋恽17

### SIGKILL淇″
ㄦョ崇绋搴杩琛17. 淇″蜂借诲澶蹇界ャ濡绠＄版涓杩绋缁姝涓浜锛灏璇棰杩涓淇″17

### SIGUSER1 SIGUSER2
绯荤缁ㄦ蜂娇ㄧ淇″17

### init杩绋
init杩绋锛瀹涓涓卞稿ㄧㄦ风骇杩绋17

歌琛锛宸茬琚杞藉ュ瀛锛寮濮杩琛锛骞跺凡濮璁惧椹卞ㄧ搴版缁绛锛涔锛灏遍杩ㄤ涪沅釜ㄦ风骇绋搴init瑰锛瀹寮瀵艰绋浠init濮缁绗涓沅釜杩绋锛**惰绋缂峰缁涓1**锛17

## 瀹よ绋
[瀛涔缃绔](http://www.cnblogs.com/mickole/p/3188321.html)
Linux Daemon锛瀹よ绋锛杩琛ㄥ扮涓绉规杩绋恽瀹绔浜у剁绔骞朵ㄦ姊悃版ц绉浠诲℃绛寰澶浜浜浠躲瀹涓瑕ㄦ疯ュ氨借琛琚涓渚绉★涓瀵规翠釜绯荤灏辨瀵规涓ㄦ风搴渚°Linux绯荤澶у版″氨杩瀹よ绋瀹扮恽17

**涓沅釜瀹よ绋惰绋init杩绋**锛涓哄姝ｇ惰绋fork哄杩绋灏卞浜瀛杩绋exit沐轰锛浠ュ涓涓init缁ф跨瀛ゅ胯绋恽瀹よ绋浜や寮绋搴锛娌℃у剁绔锛沅互浠讳杈猴璁烘杈鸿惧stdout杩洪璁惧stderr杈洪介汨规澶恽17

瀹よ绋绉伴甯镐互d缁灏撅姣濡sshdxinetdcrond绛17

### 瀹よ绋寤17
[瀛涔缃1](https://blog.csdn.net/woxiaohahaa/article/details/53487602)
[瀛涔缃2](https://www.cnblogs.com/Flychown/p/6874252.html)

#### ╃ㄨ疆瀛ュ寤哄よ绋17
瀹よ绋浠ラ杩绯荤芥daemon()ュ寤猴浣姝ゆ规涓藉娓妤瀹よ绋寤虹瑙锛姝やㄨ

<script type="preformatted">
~~~~~~~~~ C++
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>

int myPrint()
{
    while(1) {
        printf("1651574\n");
        sleep(1);
    }
    return 0;
}

int main() {
    daemon(1, 1);

    // 绂ㄨ虹插17
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);
    for( i = 0; i < 3; ++i) {
        close(i);
        open("/dev/null", O_RDWR);
        dup(0); dup(0);
    }

    myPrint();
    return 0;
}
~~~~~~~~~
</script>

#### 瀹よ绋
瀹よ绋寤烘绋锛

1. 寤哄杩绋锛惰绋棰恽沐衡猗辩绘у剁绔17
    寤哄杩绋涔惰绋沐猴浼棰瀛杩绋娌℃惰绋锛浠浣垮杩绋涓涓瀛ゅ胯绋锛姝ゅ杩绋涓浼沌惰绋棰恽沐鸿棰恽沐猴锛冲杩绋浼琚init 1疯绋棰伙姝init杩绋灏涓鸿ュ杩绋惰绋17
    Linux涓锛姣褰绯荤颁涪沅釜瀛ゅ胯绋锛灏变ㄧ171疯绋锛涔灏辨init杩绋锛跺诲锛杩凤瀛杩绋灏变init杩绋瀛杩绋浜17

<script type="preformatted">
~~~~~~~~~ C++
// 惰绋峰扮17 PID 灏浜 0, 寤烘17
if (pid < 0) {
    printf("瀛杩绋寤哄け璐ワ\n");
    exit(EXIT_FAILURE);
}    
// 惰绋峰 PID 澶т 0, 寤烘, PID 充负瀛杩绋17 PID锛跺棰恽沐虹惰绋
else if (pid > 0) {
    printf("瀛杩绋寤烘17, PID=%d\n", pid);
    exit(EXIT_SUCCESS);
}
~~~~~~~~~
</script>

    
    娉ㄦfork()芥拌ㄤ涪沔★浼杩涓ゆ★
    
    - ㄧ惰绋涓锛fork杩板寤哄杩绋杩绋ID锛17
    - ㄥ杩绋涓锛fork杩0锛17
    - 虹伴璇锛杩璐17

2. ㄥ杩绋涓寤烘颁璇猗辩荤惰绋浼璇缁杩绋缁
    璋setsid芥扮杩绋涓烘扮浼璇棣杩绋锛骞朵剁惰绋浼璇缁杩绋缁辩伙涓烘扮17 session leader 杩绋缁 leader 

<script type="preformatted">
~~~~~~~~~ C++
if(setsid() < 0) {
    printf("娉浣垮杩绋涓 SESSION LEADER!\n");
    exit(EXIT_FAILURE);
}
~~~~~~~~~
</script>

!!!    
    ㄨfork()芥版讹瀛杩绋ㄧ澶朵惰绋浼璇恽杩绋缁у剁绔绛锛界剁惰绋沐轰锛浣浼璇杩绋缁у剁绔绛骞舵病瑰锛姝わ杩涓姝ｆ涔涓绔锛琚setsid()芥拌藉浣胯绋瀹ㄧ绔烘ワ浠琚辩绘朵杩绋у讹涓轰涓拌绋17

3. 娆 fork() 涓沅釜瀛杩绋骞惰╃惰绋棰恽沐恒17
姝ラゅ抽17
**it is possible for the child to regain control of the terminal, but once it has lost control the forked grandchild cannot do this. **
板锛杩绋宸茬涓烘缁绔浼璇缁匡浣瀹浠ラ扮宠锋寮涓沅釜у剁绔锛杩 fork() 涓沅釜瀛杩绋锛璇ュ杩绋涓leader of the session锛**杩绋灏涓介版寮沔у剁绔**17

<script type="preformatted">
~~~~~~~~~ C++
// 惰绋峰扮17 PID 灏浜 0, 寤烘17
if (pid < 0) {
    printf("瀛杩绋寤哄け璐ワ\n");
    exit(EXIT_FAILURE);
}    
// 惰绋峰 PID 澶т 0, 寤烘, PID 充负瀛杩绋17 PID
else if (pid > 0) {
    printf("瀛杩绋寤烘17, PID=%d\n", pid);
    exit(EXIT_SUCCESS);
}
~~~~~~~~~
</script>

4. 瑰宸ヤ褰浠舵╃17
杩绋娲诲ㄦ讹跺伐浣褰ㄧ浠剁郴缁涓藉镐(姣濡宸ヤ褰ㄤ涓NFS涓17,杩琛涓沅釜daemon浼瀵艰umount娉)涓瑕灏宸ヤ褰瑰版圭褰瀵逛瑕杞ㄦ稿锛杩琛ュ杩绋灏宸ヤ褰瑰扮瑰褰濡chdir("/tmp")锛杩绋浠寤哄惰绋ｉ缁ф夸浠跺寤烘╂ā瀹戒慨瑰よ绋沐寤虹浠剁瀛浣恽涓洪叉㈣涓癸灏浠跺寤烘╂ā娓わumask(0); **???why???**
<script type="preformatted">
~~~~~~~~~ C++
chdir("/");
umask(0);
~~~~~~~~~
</script>
朵腑`umask`╂ā芥板浠ュ琚[杩绡瀹](https://www.cnblogs.com/sench/p/8933638.html)

5. ㄥ杩绋涓抽浠讳涓汨浠舵杩扮17
fork芥版板缓瀛杩绋浼浠惰绋ｉ缁ф夸浜宸茬寮沅浠躲杩浜琚寮浠跺芥案杩涓浼琚瀹よ绋璇诲锛浣瀹浠涓沔锋绯荤璧婧锛涓藉艰存沐ㄧ浠剁郴缁娉镐17
ㄤ㈢绗浜姝ヤ锛瀹よ绋宸茬涓灞у剁绔澶卞讳绯汇姝や缁绔杈ョ瀛绗涓借揪板よ绋锛瀹よ绋涓ㄥ父瑙规锛濡printf锛杈虹瀛绗涔涓藉ㄧ绔涓剧ず烘ャ浠ワ浠舵杩扮涓0171172 173涓浠讹甯歌寸杈ャ杈哄ラ锛宸茬澶卞讳瀛ㄧ浠峰硷涔搴琚抽17.
<script type="preformatted">
~~~~~~~~~~~ C++
/* 抽浠惰绋缁ф挎ョ浠舵杩扮17 */
#ifdef RLIMIT_NOFILE
if (getrlimit(RLIMIT_NOFILE, &rl) == -1)
    ERROR_EXIT("getrlimit failed!");
nfiles = rl.rlim_cur = rl.rlim_max;
setrlimit(RLIMIT_NOFILE, &rl);
for(i=3; i < nfiles; i++)
    close(i);
#endif
~~~~~~~~~~~
</script>

6. 瀹170,1,2浠舵杩扮17
灏涓涓浠舵杩扮瀹17/dev/null涓17

<script type="preformatted">
~~~~~~~~~~~ C++
/* 瀹3涓浠舵杩扮 */
if(fd = open("/dev/null", O_RDWR) < 0)
    ERROR_EXIT("open /dev/null failed!");
for(i=0; i < 3; i++)
    dup2(fd, i);
~~~~~~~~~~~
</script>

!!! 
    朵腑4锛175锛176姝ラゆ瀵瑰宸ヤ澧淇癸浠ュ锛涓鸿浜淇归戒琚瀛杩绋缁ф夸17

翠test2.c浠ｇ濡涓锛17

<script type="preformatted">
~~~~~~~~~~~~~~ C++
#include <stdio.h>
#include <unistd.h> //  dup(),dup2(),setsid()芥扮澶存浠
#include <stdlib.h>
#include <signal.h>
#include <sys/types.h>  // setsid()芥扮澶存浠
#include <sys/stat.h>
#include <fcntl.h>

int myPrint()
{
    while(1) {
        printf("1651574\n");
        sleep(5);
    }
    return 0;
}

void myDaemonize()
{
    pid_t pid;
    int i, fd;

    // 寤轰涪沅釜瀛杩绋
    pid = fork();

    // 惰绋峰扮17 PID 灏浜 0, 寤烘17
    if (pid < 0) {
        printf("瀛杩绋寤哄け璐ワ\n");
        exit(EXIT_FAILURE);
    }
    // 惰绋峰 PID 澶т 0, 寤烘, PID 充负瀛杩绋17 PID
    else if (pid > 0) {
        printf("瀛杩绋寤烘17, PID=%d\n", pid);
        exit(EXIT_SUCCESS);
    }

    // 浠ヤ浣冲ㄥ杩绋杩琛17
    // 浣垮杩绋辩诲杩绋缁, 涓烘扮 session leader 杩绋缁 leader
    if ( setsid() < 0 ) {
        printf("娉浣垮杩绋涓 SESSION LEADER!\n");
        exit(EXIT_FAILURE);
    }

    // 娆 fork 瀛杩绋17, 骞剁姝㈠杩绋
    pid = fork();
    if (pid < 0) {
        printf("瀛杩绋寤哄け璐ワ\n");
        exit(EXIT_FAILURE);
    }
    else if (pid > 0) {
        printf("瀛杩绋寤烘17, PID=%d\n", pid);
        exit(EXIT_SUCCESS);
    }

    // 璁剧疆浠舵浠ュ扮宸ヤ褰
    umask(0);
    chdir("/");
    
    // 抽浠惰绋缁ф挎ョ浠舵杩扮17
#ifdef RLIMIT_NOFILE
    if (getrlimit(RLIMIT_NOFILE, &rl) == -1)
        printf("getrlimit failed!");
    nfiles = rl.rlim_cur = rl.rlim_max;
    setrlimit(RLIMIT_NOFILE, &rl);
    for(i=3; i < nfiles; i++)
        close(i);
#endif

    // 瀹3涓浠舵杩扮
    if (fd = open("/dev/null", O_RDWR) < 0)
        printf("open /dev/null failed!");
    for (i=0; i < 3; i++)
        dup2(fd, i);
}

int main()
{
    myDaemonize();
    myPrint();
    return 0;
}
~~~~~~~~~~~~~~
</script>

### 杩琛瀹よ绋

变惧ワmake寤哄锛ц浠剁锛骞舵病诲bash锛姝よ存绋搴宸茬浣涓烘瀹よ绋杩琛
![](./pic/2-2.png)


### ョ test2 杩绋璇惰绋璇
灏璇17 jobs ョ颁涓琛, 浣娌℃寰拌17, 璇存涓や釜瀹よ绋宸茬涓缁绔у17

![](./pic/2-3.png)

浣跨`ps l -C ц浠跺` ヨ㈣绋锛17 瑙瀵拌绋PID=2016, 惰绋PPID=1, 宸茬涓哄ゅ胯绋锛琚init杩绋(CentOS涓涓`systemd`)ョ′负瀛杩绋

![](./pic/2-4.png)

涓杩绋瀵规锛ㄦ戒护琛杩琛test1-2,杈"璐炬17"

![](./pic/2-5.png)

寮涓涓戒护琛锛棰杩ps l戒护ョ

![](./pic/2-6.png)

浠ヨ瀵板浠ユヨ㈠板test1-2杩绋锛浣瀹よ绋test2骞舵病17

变瀹よ绋ㄥ雹沌锛涓у跺版筹涓涓у跺お澶峰浠ョ`ps l -C ц浠跺` ョ杩绋淇℃

![](./pic/2-7.png)

`TTY`涓沔剧ず涓`?`,琛ㄧず涓灞浜浠讳缁绔17

杩`CTRL+D` 沐哄锛涓戒护琛涓瑙瀵 test2涓test1-2

![](./pic/2-8.png)

state涓 stop锛浣瀹よ绋flag涓171

<!-- 涓轰灏test2版板ㄦ扮绔涓锛汨瀹瑁`reptyr`,浠[CentOS package瀹缃](https://centos.pkgs.org/7/epel-x86_64/reptyr-0.5-1.el7.x86_64.rpm.html) 涓杞介
CentOS 7 17 reptyr RPM 17, 浼棰拌轰. ㄨ轰浣跨17 `yum install -y reptyr-0.5-
1.el7.x86_64.rpm` 瀹瑁
![](./pic/2-9.png)

`reptyr -s 瀹よ绋PID` 戒护灏浠よ哄版扮绔17
![](./pic/2-10.png) -->

<!-- **琚妗**锛绉规浠ュ:
### 杩绋涓娑淇瀛
1. ╃ㄤ杩`reptyr -s PID`
2. 浣跨ㄦュ浠讹杈洪瀹虫ュ浠17
3. 浣跨screen宸ュ
4. 浣跨ㄤ俊峰ㄦ瑰绋搴杩琛杈虹 pts 璁惧 -->

# 靛案杩绋澶17

## 浠ｇ濡涓
<script type="preformatted">
~~~~~~~~~~~~~ C++
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

void childProcess()
{
    pid_t pid, ppid;
    int i;
    for (i=0 ; i < 3 ; i++) {
        ppid = getppid();
        pid = getpid();
        printf("%d+%d+1651574+sub\n", (int)ppid, (int)pid);
        sleep(25);
    }
}

int main()
{
    pid_t pid, ppid;
    int i;

    for (i = 0 ; i < 10 ; i++) {

        // fork()涓や釜杩绋杩澧17
        pid = fork();
        if (pid < 0) {
            printf("寤哄杩绋澶辫17!\n");
            exit(EXIT_FAILURE);
        }
        // 濡褰涓哄杩绋
        if (pid == 0) {
            childProcess();
            exit(EXIT_SUCCESS);
        }
        sleep(3);
    }

    while(1) {
        ppid = getppid();
        pid = getpid();
        printf("%d+%d+1651574+main\n", (int)ppid, (int)pid);
        sleep(5);
    }
    return 0;
}
~~~~~~~~~~~~~
</script>

姝ｇ‘杈

![](./pic/3-1.png)

## 瀛杩绋涓瀹よ绋崇郴
淇绋搴杩琛锛杞板涓缁绔锛棰杩`ps f -l -C test3-1`剧ずtest3-1崇杩绋
**涔杩 ps f l -C test3-1**戒护ョ锛杈灏哄17

![](./pic/3-2.png)

缁琛ㄦ 2471疯绋涓虹惰绋17

## 靛案杩绋

[瀛涔缃绔1](https://www.cnblogs.com/Anker/p/3271773.html)
[瀛涔缃绔2](https://www.cnblogs.com/wuchanming/p/4020463.html)

### 靛案杩绋姒蹇17
靛案杩绋锛涓涓杩绋浣跨fork寤哄杩绋锛濡瀛杩绋棰恽沐猴惰绋骞舵病璋waitwaitpid峰瀛杩绋缁舵淇℃锛ｄ瀛杩绋杩绋杩扮浠朵瀛ㄧ郴缁涓恽杩绉杩绋绉颁涓哄垫昏绋

### 璁剧疆靛案杩绋17
缁存ゅ杩绋淇℃锛浠ヤ究惰绋ㄤ互涓跺峰恽杩浜淇℃冲杩绋ID锛杩绋缁姝㈢舵锛浠ュ璇ヨ绋浣跨ㄧCPU堕达浠ュ缁姝㈠杩绋惰绋璋waitwaitpid跺氨浠ュ拌浜淇℃

### 瑙瀵靛案杩绋
褰涓荤搴杩琛宠哄ㄩㄤ负main讹ㄥ涓缁绔瑙瀵test3-1宠绋锛stateS涓Z(Zombie)

![](./pic/3-3.png)
![](./pic/3-4.png)

### 沔诲靛案杩绋寰
瀵逛涓沅釜瀹浜х瀛杩绋惰绋锛浜х瀛杩绋汨浜寰灏锛瀛杩绋瀹璇ュ浜涔灏遍恽沐轰锛藉ㄦ寰浣锛惰绋绠＄扮瀛杩绋锛充瀛杩绋 沐轰浜锛涓沔涓讳锛杩凤绯荤杩琛涓涓沔垫堕翠锛绯荤涓灏变瀛ㄥ澶垫昏绋锛澧ョps戒护ョ璇锛灏变板澶舵涓Z杩绋恽17 涓ユ煎版ヨ达垫昏绋骞朵棰规锛缃榄绁搁**浜х哄ぇ垫昏绋ｄ釜惰绋17**姝わ褰浠瀵绘濡浣娑绯荤涓澶ч垫昏绋讹绛妗灏辨浜х澶ч垫昏绋ｄ釜舵姣锛抽杩杩kill棰SIGTERM琚SIGKILL沔荤惰绋姣浜惰绋涔锛瀹浜х垫昏绋灏卞浜瀛ゅ胯绋锛杩浜瀛ゅ胯绋浼琚init杩绋ョ★init杩绋浼wait()杩浜瀛ゅ胯绋锛惧浠ㄧ绯荤杩绋琛ㄤ腑璧婧锛杩凤杩浜宸茬垫荤瀛ゅ胯绋 灏辫界讳17

### 靛案杩绋澶17
沔讳浠惰绋锛浣夸浠涓哄ゅ胯绋锛杩琚琚init 1疯绋ョ撼娓17

![](./pic/3-5.png)

涓句腑涓㈢绠澶翠负灏璇姝诲靛案杩绋锛浣缁ョ娌℃沔17
涓圭绠澶翠负沔荤惰绋锛缁ョ惰绋涓剁瀛锛靛案锛杩绋涓骞惰沔17

### 垮澶чㄥ靛案杩绋棰寰

杩signal(SIGCHLD, SIG_IGN)ュ稿瑰杩绋缁涓冲锛卞稿躲濡涓宠╃惰绋璧凤浠ュㄧ惰绋涓ヤ¤ワsignal(SIGCHLD,SIG_IGN);琛ㄧず惰绋蹇界SIGCHLD淇″凤璇ヤ俊锋瀛杩绋沐虹跺惰绋
<script type="preformatted">
~~~~~~~~~~~~~ C++
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

void childProcess()
{
    pid_t pid, ppid;
    int i;
    for (i=0 ; i < 3 ; i++) {
        ppid = getppid();
        pid = getpid();
        printf("%d+%d+1651574+sub\n", (int)ppid, (int)pid);
        sleep(25);
    }
}

int main()
{
    pid_t pid, ppid;
    int i;

    signal(SIGCHLD, SIG_IGN);

    for (i = 0 ; i < 10 ; i++) {

        // fork()涓や釜杩绋杩澧17
        pid = fork();
        if (pid < 0) {
            printf("寤哄杩绋澶辫17!\n");
            exit(EXIT_FAILURE);
        }
        // 濡褰涓哄杩绋
        if (pid == 0) {
            childProcess();
            exit(EXIT_SUCCESS);
        }
        sleep(3);
    }

    while(1) {
        ppid = getppid();
        pid = getpid();
        printf("%d+%d+1651574+main\n", (int)ppid, (int)pid);
        sleep(5);
    }
    return 0;
}
~~~~~~~~~~~~~
</script>
瑙瀵缁

![](./pic/3-6.png)

ㄥ杩绋杩琛缁锛变惰绋蹇界ヤSIGCHLD淇″凤init璐璐wait娓杩琛缁瀛杩绋锛姝ゅ版病靛案杩绋17

# 瀹よ绋跺杩绋澶

## 浠ｇ
涓轰戒璇姝荤搴锛涓浜х靛案杩绋锛娣诲`signal(SIGCHLD, SIG_IGN)`
<script type="preformatted">
~~~~~~~~~~ C++
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

void childProcess()
{
    pid_t pid, ppid;
    int i;
    while (1) {
        ppid = getppid();
        pid = getpid();
        printf("%d+%d+1651574+sub\n", (int)ppid, (int)pid);
        sleep(15);
    }
}

int main()
{
    pid_t pid, ppid;
    int i;

    signal(SIGCHLD, SIG_IGN);

    for (i = 0 ; i < 10 ; i++) {

        // fork()涓や釜杩绋杩澧17
        pid = fork();
        if (pid < 0) {
            printf("寤哄杩绋澶辫17!\n");
            exit(EXIT_FAILURE);
        }
        // 濡褰涓哄杩绋
        if (pid == 0) {
            childProcess();
            exit(EXIT_SUCCESS);
        }
        sleep(3);
    }

    while(1) {
        ppid = getppid();
        pid = getpid();
        printf("%d+%d+1651574+main\n", (int)ppid, (int)pid);
        sleep(5);
    }
    return 0;
}

~~~~~~~~~~
</script>

## 沔绘涓沐杩绋17
寮涓缁绔锛浣跨`kill`沔诲杩绋

![](./pic/4-1.png)

## 蹇棰姝绘瀛杩绋

`pkill -P 惰绋PID` 戒护浠ュ揩棰姝绘瀹惰绋瀛杩绋

![](./pic/4-2.png)

## 沔荤惰绋

ョ戒护`ps f l -C test4-1`

![](./pic/4-3.png)

瑙瀵板杩绋惰绋ㄩㄥ涓轰init1疯绋锛骞朵STAT舵灞хS+涓轰S锛璇存瀹浠涓у跺扮拌绋17.

## 浠ｇ硅锛浣挎沔荤惰绋讹缁姝㈡沔瀛杩绋

[瀛涔缃1](https://www.cnblogs.com/nufangrensheng/p/3514547.html)
[瀛涔缃2](https://www.cnblogs.com/leeming0222/articles/3994125.html)
[瀛涔缃3](https://blog.csdn.net/qq_35420908/article/details/70175247)

### 琛ュヨ
- signal() 淇″峰绋搴锛signal handler锛淇″锋芥帮signal-catching function锛锛涓烘瀹淇″峰瑁涓沅釜扮淇″峰芥17
~~~~~~~~ C++
#include <signal.h>
void ( *signal(int signo, void (*func)(int)))(int);

#define    SIG_ERR        ( void (*) () )-1
#define    SIG_DFL        ( void (*) () )0
#define    SIG_IGN        ( void (*) () )1
~~~~~~~~
signo版淇″峰锛func澧慵甯搁SIG_IGN甯搁SIG_DFL褰ュ版や俊峰瑕璋ㄧ芥扮板
    - SIG_IGN锛歌〃绀哄拷ユや俊凤璁颁涓や釜淇″SIGKILLSIGSTOP涓藉拷ワ17
    - SIG_DFL锛琛ㄧずュ版や俊峰ㄤ绯荤榛璁ゅㄤ17
    - 芥板板锛ㄤ俊峰讹浼棰璇ヤ俊风杩涓芥板苟璋锛浠绉拌绉澶涓衡猗璇ヤ俊
signal杩澧慵涔淇″峰绋搴,琚SIG_ERR

- kill()芥帮17
<script type="preformatted">
~~~~~~~~~ C++
#include <sys/types.h>
#include <signal.h>
int kill(pid_t pid, int sig);
~~~~~~~~~
</script>

    - pid

        - pid澶т舵讹pid淇″锋查寰杩绋璇17
        - pid绛浜舵讹sig淇″峰棰寰沔涓璋kill()ｄ釜杩绋灞涓涓浣跨ㄧ杩绋恽17
        - pid绛浜-1讹sig淇″峰棰寰沔璋ㄨ绋缁跺淇″风杩绋锛や杩绋171(init)17
        - pid灏浜-1讹sig淇″峰棰寰浠17-pid涓虹璇杩绋恽17
ц讹杩0澶辫触杩17-1

### 浠ｇ瀹
- 规1锛╃ㄤ俊峰芥17
<script type="preformatted">
~~~~~~~~~~ C++
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

void killAll(int sig)
{
    // if (sig != SIGTERM && sig != SIGINT && sig != SIGUP)
    //     return;

    if(kill(0, SIGTERM) == -1)
        exit(EXIT_FAILURE);
    exit(EXIT_SUCCESS);
}

void childProcess()
{
    pid_t pid, ppid;
    int i;

    signal(SIGCHLD, SIG_DFL);
    signal(SIGTERM, SIG_DFL);
    signal(SIGINT, SIG_DFL);
    signal(SIGHUP, SIG_DFL);

    while (1) {
        ppid = getppid();
        pid = getpid();
        printf("%d+%d+1651574+sub\n", (int)ppid, (int)pid);
        sleep(15);
    }
}

int main()
{
    pid_t pid, ppid;
    int i;

    signal(SIGCHLD, SIG_IGN);
    signal(SIGTERM, killAll);
    signal(SIGINT, killAll);
    signal(SIGHUP, killAll);


    for (i = 0 ; i < 10 ; i++) {

        // fork()涓や釜杩绋杩澧17
        pid = fork();
        if (pid < 0) {
            printf("寤哄杩绋澶辫17!\n");
            exit(EXIT_FAILURE);
        }
        // 濡褰涓哄杩绋
        if (pid == 0) {
            childProcess();
            exit(EXIT_SUCCESS);
        }
        sleep(3);
    }

    while(1) {
        ppid = getppid();
        pid = getpid();
        printf("%d+%d+1651574+main\n", (int)ppid, (int)pid);
        sleep(5);
    }
    return 0;
}
~~~~~~~~~~
</script>
杩琛缁濡涓

![](./pic/4-4.png)

沔荤惰绋跺锛沔瀛杩绋涔姝17

娉ㄦㄥ杩绋涓ヤ杩颁俊锋у朵唬寰瑕锛ㄤ叉㈤褰淇″凤17
~~~~~~ C++
signal(SIGCHLD, SIG_DFL);
signal(SIGTERM, SIG_DFL);
signal(SIGINT, SIG_DFL);
signal(SIGHUP, SIG_DFL);
~~~~~~

- 规2锛17
ㄥ杩绋涓`prctl(PR_SET_PDEATHSIG, SIGTERM)`锛浣跨郴缁ㄧ惰绋姝讳骸讹瀛杩绋棰`SIGTERM`浠ョ姝浠浠17
<script type="preformatted">
~~~~~~~~~~ C++
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

void killAll(int sig)
{
    // if (sig != SIGTERM && sig != SIGINT && sig != SIGUP)
    //     return;

    if(kill(0, SIGTERM) == -1)
        exit(EXIT_FAILURE);
    exit(EXIT_SUCCESS);
}

void childProcess()
{
    pid_t pid, ppid;
    int i;

    prctl(PR_SET_PDEATHSIG, SIGTERM)
  
    signal(SIGCHLD, SIG_DFL);

    while (1) {
        ppid = getppid();
        pid = getpid();
        printf("%d+%d+1651574+sub\n", (int)ppid, (int)pid);
        sleep(15);
    }
}

int main()
{
    pid_t pid, ppid;
    int i;

    signal(SIGCHLD, SIG_IGN);

    prctl(PR_SET_PDEATHSIG, SIGTERM)

    for (i = 0 ; i < 10 ; i++) {

        // fork()涓や釜杩绋杩澧17
        pid = fork();
        if (pid < 0) {
            printf("寤哄杩绋澶辫17!\n");
            exit(EXIT_FAILURE);
        }
        // 濡褰涓哄杩绋
        if (pid == 0) {
            childProcess();
            exit(EXIT_SUCCESS);
        }
        sleep(3);
    }

    while(1) {
        ppid = getppid();
        pid = getpid();
        printf("%d+%d+1651574+main\n", (int)ppid, (int)pid);
        sleep(5);
    }
    return 0;
}
~~~~~~~~~~
</script>

# 瑁瀛绋搴娴璇
## 浠ｇ
<script type="preformatted">
~~~~~~~~ C++
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <fcntl.h>
#include <sys/prctl.h>
#include <linux/random.h>
#include <errno.h>
#include <sys/wait.h>

#define str_len 1024

void killAll(int sig)
{
    // if (sig != SIGTERM && sig != SIGINT && sig != SIGUP)
    //     return;

    prctl(PR_SET_PDEATHSIG, SIGTERM);
    if(kill(0, SIGTERM) == -1)
        exit(EXIT_FAILURE);
    exit(EXIT_SUCCESS);
}

void childProcess()
{
    char tmp_str[str_len];
    int i = 0;
    for(i = 0 ; i < str_len;i++)
        tmp_str[i] = (char)(rand()%255);

    while(1)
        sleep(1000);
}

int main(int argc, char **argv)
{
    if(argc != 2){
        printf("璇疯ヤ涓拌〃绀哄惊娆℃\n");
        exit(-1);
    }

    signal(SIGCHLD, SIG_IGN);
    pid_t pid, ppid;
    int k = atoi(argv[1]), i;


    for (i = 0 ; i < k ; i++) {

        pid = fork();
        if (pid < 0) {
            printf("惰绋瑁澶辫17!\n");
            break;
            // exit(EXIT_FAILURE);
        }
        if (pid == 0) {
            childProcess();
            exit(EXIT_SUCCESS);
        }
        if(i % 100 == 0)
            printf("宸插瑁17%d涓瀛杩绋\n", i);
    }

    printf("昏″瑁浜17 %d 涓瀛杩绋\n", i);

    while(1)
        sleep(1000);

    return 0;
}
~~~~~~~~
</script>

## 瀹楠姝ラ

### 虹娴璇
棣灏哄璁剧疆512MB锛171024MB锛172048MB

![](./pic/5-1.png)

杩琛绋搴锛512MB锛171024MB锛172048MB杩琛缁濡涓

![](./pic/5-2.png) ![](./pic/5-3.png) ![](./pic/5-4.png) 

### 灏宠峰瀛╁ぇ娴璇
灏17#define str_len 1024 逛负#define str_len 10240锛17 拌琛娴璇

![](./pic/5-2.png) ![](./pic/5-3.png) ![](./pic/5-4.png) 

姣涓杩绋宠风绌洪存╁ぇ锛浣板寤虹瀛杩绋伴涔娌℃锛姝ょ郴缁璁告澶ц绋颁涓瀛澶у

### 绛寰娴璇
变绯荤璁告沐ぇ杩绋版讹姝ゅ╃ㄥ朵绋搴缁瑁绛ワ浣胯藉绫绘村瀛杩绋
姝わ褰灏璇宠疯绋澶辫触讹涓存exit璇浠ｇ锛琚绛寰wait()锛娆″璇宠

wait()芥帮杩绋涓璋ㄤ wait锛灏辩抽诲宸憋waitㄥ褰杩绋涓瀛杩绋宸茬沐猴濡璁╁惧颁杩蜂涓宸茬靛案瀛杩绋锛wait 灏变堕杩涓瀛杩绋淇℃锛17 骞舵瀹褰诲姣杩锛濡娌℃惧拌蜂涓瀛杩绋锛wait灏变涓沌撮诲ㄨ锛村版涓沅釜虹颁负姝17
<script type="preformatted">
~~~~~~~~ C++
#include<sys/types.h>
#include<sys/wait.h>
pid_t wait (int * status);
~~~~~~~~
</script>

wait()浼跺姝㈢杩绋ц锛村版淇″锋ュ版瀛杩绋缁濡ㄨwait()跺杩绋宸茬缁锛wait()浼绔宠瀛杩绋缁舵澧慵恽17
**瀛杩绋缁舵澧17**浼卞**status**杩锛琚瀛杩绋PID涔浼涓沐苟杩恽濡涓ㄦ缁舵澧慵锛status 浠ヨ炬NULL
杩锛濡ц杩瀛杩绋PID锛濡璇杩17-1澶辫触瀛浜errno 涓恽17

**娉ㄦ棰瀛杩绋＄1720s澶..规2s绾堕 = =**
浠ｇ锛17
<script type="preformatted">
~~~~~~~~~ C++
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <fcntl.h>
#include <sys/prctl.h>
#include <linux/random.h>
#include <errno.h>
#include <sys/wait.h>

#define str_len 1024

void killAll(int sig)
{
    prctl(PR_SET_PDEATHSIG, SIGTERM);
    if(kill(0, SIGTERM) == -1)
        exit(EXIT_FAILURE);
    exit(EXIT_SUCCESS);
}

void childProcess()
{
    char tmp_str[str_len];
    int i = 0;
    for(i = 0 ; i < str_len;i++)
        tmp_str[i] = (char)(rand()%255);

    sleep(2);
}

int main(int argc, char **argv)
{
    if(argc != 2){
        printf("璇疯ヤ涓拌〃绀哄惊娆℃\n");
        exit(-1);
    }

    signal(SIGCHLD, SIG_IGN);
    pid_t pid, ppid;
    int k = atoi(argv[1]), i;
    int status, max_pid = -1;


    for (i = 0 ; i < k ; i++) {
        pid = fork();
        if (pid < 0) {

            printf("惰绋瑁澶辫触锛灏璇绛寰娆＄宠疯绋17!\n");
            wait(&status);
            i --;
            continue;
        }
        if (pid == 0) {
            childProcess();

            exit(EXIT_SUCCESS);
        }

        max_pid = max_pid > pid ? max_pid : pid;
        
        if(i % 100 == 0)
            printf("宸插瑁17%d涓瀛杩绋锛褰澶pid涓17%d\n", i, max_pid);
    }

    printf("昏″瑁浜17 %d 涓瀛杩绋\n", i);

    while(1)
        sleep(1000);

    return 0;
}
~~~~~~~~~
</script>

ョ缁锛璁剧疆瀛浠涓17512MB讹杩绛寰缁猗绛ワ宠100000涓瀛杩绋
![](./pic/5-5.png)
杩`ps l f -C test5-2` ョ沐浠17 惰绋17
![](./pic/5-6.png)

## 瀹よ绋跺杩绋骞惰℃
waitpid()芥
<script type="preformatted">
~~~~~~~~~ C++
#include <sys/types.h> /* 渚绫诲pid_t瀹涔17 */
#include <sys/wait.h>
pid_t waitpid(pid_t pid,int *status,int options)
~~~~~~~~~
</script>
- pid帮17
    - pid > 0: 绛寰杩绋ID绛浜pid瀛杩绋锛涓绠″跺宸茬澶灏瀛杩绋杩琛缁棰恽沐轰锛瑕瀹瀛杩绋杩娌℃缁锛waitpid灏变涓沌寸涓
    - pid = -1: 绛寰浠讳涓沅釜瀛杩绋沐猴娌℃浠讳讹姝ゆwaitpidwait浣ㄤ妯′枫17
    - pid = 0: 绛寰涓涓杩绋缁涓浠讳瀛杩绋锛濡瀛杩绋宸茬ヤ杩绋缁锛waitpid涓浼瀵瑰浠讳恽17
    - pid < -1: 绛寰涓沅釜瀹杩绋缁涓浠讳瀛杩绋锛杩涓杩绋缁ID绛浜pid缁瀵瑰慵恽17
- options帮Linux涓WNOHANG, 琛ㄧず娌℃瀛杩绋棰恽沐猴瀹涔浼绔宠锛涓浼waitｆ锋案杩绛涓17
- 杩硷
    - 褰姝ｅ父杩跺锛waitpid杩堕扮瀛杩绋杩绋ID
    - 濡璁剧疆浜棰椤WNOHANG锛琚璋ㄤ腑waitpid版病宸查恽沐虹瀛杩绋堕锛杩0
    - 濡璋ㄤ腑洪锛杩17-1锛杩errno浼琚璁剧疆稿间互绀洪璇沐17

## 浠ｇ
<script type="preformatted">
~~~~~~~~~~~ C++
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <fcntl.h>
#include <sys/prctl.h>
#include <linux/random.h>
#include <errno.h>
#include <sys/wait.h>

#define str_len 1024

int ctr_rqt,ctr_rcy, ctr_p;
int max_pid = -1;
int father_pid;

void printResult(int sig)
{
    if(getpid() == father_pid){
        printf("~~~~~~~~~~~~~~~~~~~~~~\n");
        printf("昏″瑁浜17 %d 涓瀛杩绋\n", ctr_p);
        printf("沐ぇpid涓17%d\n",max_pid);
        printf("宠锋颁负: %d, 舵颁负: %d\n", ctr_rqt, ctr_rcy);
        printf("~~~~~~~~~~~~~~~~~~~~~~\n");
        exit(EXIT_SUCCESS);
    }
}

void childProcess()
{
    // signal(SIGCHLD, SIG_DFL);
    // signal(SIGTERM, SIG_DFL);
    // signal(SIGINT, SIG_DFL);
    // signal(SIGHUP, SIG_DFL);
    char tmp_str[str_len];
    int i = 0;
    for(i = 0 ; i < str_len;i++)
        tmp_str[i] = (char)(rand()%255);

    sleep(10);
}

void recycleCount(int sig)
{
    int status;
    while(1){
        if(waitpid(-1,&status, WNOHANG) > 0)
            ctr_rcy++;
        else
            break;
    }
}

int main(int argc, char **argv)
{
    if(argc != 2){
        printf("璇疯ヤ涓拌〃绀哄惊娆℃\n");
        exit(-1);
    }

    signal(SIGCHLD, &recycleCount);
    signal(SIGINT, &printResult);

    father_pid = getpid();
    pid_t pid, ppid;

    int k = atoi(argv[1]);
    int status;


    for (ctr_p = 0 ; ctr_p < k ; ctr_p++) {
        pid = fork();
        if (pid < 0) {
            printf("惰绋瑁澶辫触锛灏璇绛寰娆＄宠疯绋17!\n");
            sleep(5);
            ctr_p --;
            continue;
        }
        if (pid == 0) {
            childProcess();
            exit(EXIT_SUCCESS);
        }

        ctr_rqt ++;
        max_pid = max_pid > pid ? max_pid : pid;
        
        if(ctr_p % 100 == 0)
            printf("宸插瑁17%d涓瀛杩绋锛褰澶pid涓17%d锛褰宠17%d涓杩绋锛%d涓杩绋\n", ctr_p, max_pid, ctr_rqt, ctr_rcy);
    }

    // wait the sub process to end
    while(1)
        if(ctr_rcy==ctr_rqt)
 			break;

    printResult(0);
    return 0;
}
~~~~~~~~~~~
</script>

![](./pic/5-7.png)

濡炬沌ず锛宠峰瀛颁惧瀛扮稿17
绋搴璇存锛17

- 瀛绋搴娈childProcess涓锛涓沅浠ｇ骞朵藉濂界绘signal褰璋
~~~~~~~~~~~~~~ C++
signal(SIGCHLD, SIG_DFL);
signal(SIGTERM, SIG_DFL);
signal(SIGINT, SIG_DFL);
signal(SIGHUP, SIG_DFL);
~~~~~~~~~~~~~~
剁搴fork()轰涓瀛绋搴锛ュㄦц涓杩signal淇″疯剧疆涔锛CTRL+C涓戒护浣垮朵瀛绋搴姝锛褰fork()虹瀛绋搴浠朵淇″
姝ゆ沐ソ瑙ｅ冲娉涓哄ㄧinterupt绋搴涓ワゆ涓虹惰绋ip 

- waitpid(-1,xxxx,xxx)虹绫讳技浜wait锛姝ょ村版ユ朵涓SIGCHLD淇″凤浼ц涓㈢璇ワ琚绛寰淇″烽舵垫涓洪诲姊锛**娉ㄦ!**цsignal()芥扮骞堕惰绋涔瀛杩绋锛搴璇ヤ负system绯荤涓涓杩绋ц锛姝ゅ绋搴涓虹扮`while(1)`浠ヨや负涓绉榛璁わ垮浜澶чSIGCHLD淇″蜂琚蹇界ヨ娌℃琚绯荤ユ跺扮涓沌娉17



<!-Markdeep: --><style class="fallback">body{visibility:hidden}</style><script src="markdeep.min.js"></script>

<script src="jquery-3.3.1.min.js"></script>

<script type="text/javascript">
    $(document).ready(function(){setTimeout(function(){$(".image a").removeAttr("href")}, 0)});
</script>

<style>
    /* .md h2::before{
        content: counter(h2, lower-alpha)
    }

    .md h2.notinc::before{
        counter-increment: none;
        content: none
    }

    div.notinc1 h1::before{
        counter-increment: none;
        content: "2*"
    }

    .md h1.notinc::before{
        counter-increment: none;
    } */

    .md .image {
        width: 80%;
    }

    .md img {
        border: 1.3px rgb(0, 0, 0) solid;
    }

    .md div.imagecaption {
        text-align: center;
    }

    /* .level2 .tocnumber {
        display: none
    } */

    .md code {
        background-color: rgba(255, 249, 158, 0.788);
        color: rgb(145, 52, 40);
    }

    .md pre code {
        background: none;
        /* background-color: rgb(250, 238, 224); */
        /* border: 1.0px rgb(0, 0, 0) solid; */
    }

    body {
        font-family: 绛绾,Palatino,Georgia,"Times New Roman",serif;
    }
</style>
